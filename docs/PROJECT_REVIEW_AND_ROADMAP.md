# Kotlin SMTP (Relay 포함, 인터넷 노출 목표) — 프로젝트 리뷰 & 작업 로드맵

> 이 문서는 **인터넷에 노출 가능한 SMTP 서버(릴레이 포함)** 구현을 목표로, 현재 코드베이스의 수준/리스크/갭을 정리하고 “다시 시작” 관점의 단계별 로드맵을 제시합니다.
>
> 작성 기준: RFC 5321(기본 SMTP), RFC 3207(STARTTLS), 운영/보안 관점(크리덴셜 로그/오픈 릴레이 방지/리소스 보호) 우선.

---

## 목표(Goal)와 범위(Scope)

### 목표

- **인터넷 노출 가능한 SMTP 서버**: 외부 MTA/클라이언트가 접속해 메일을 수신할 수 있어야 함
- **릴레이 포함**: 로컬 도메인 수신 + 외부 도메인으로의 아웃바운드 릴레이(또는 스풀 기반 재시도) 지원
- **안전/신뢰**: STARTTLS/AUTH/릴레이 정책이 안전하게 동작하고, 실패 시 응답이 RFC 의미에 맞게 일관적이어야 함

### 비목표(현재 단계에서 제외 권장)

- 고급 스팸 필터링/바이러스 스캔(초기에는 “연동 포인트”만 설계)
- 완전한 RFC 확장 구현(PIPELINING, SMTPUTF8, 8BITMIME 등은 단계적으로)
- 대규모 클러스터링/분산 큐(초기엔 단일 노드 안정화 → 이후 확장)

---

## 현재 상태 요약(As-Is)

### 한 줄 평가

- **“동작하는 SMTP 수신 데몬(POC~베타)” 기반은 있음**. 하지만 인터넷 노출/릴레이까지 “프로덕션급”으로 보기엔 **치명 버그/보안 리스크/RFC 디테일 부족**이 남아 있음.

### 현재 구현된 큰 흐름

- Netty 기반 TCP 서버 → 라인 디코딩 → `SmtpSession` 큐 → `SmtpCommands` 디스패치 → `SmtpProtocolHandler` 트랜잭션 처리
- 기본 커맨드: `HELO`, `EHLO`, `MAIL`, `RCPT`, `DATA`, `RSET`, `NOOP`, `QUIT`, `HELP`, `VRFY(부분)`, `EXPN(미지원)`
- STARTTLS: `STARTTLS` 커맨드/세션 플래그/후속 EHLO 강제 플래그 존재
- AUTH: `AUTH PLAIN`(TLS 이후만 허용), 실패 시 지수 백오프(세션 단위)
- 저장/전달:
  - 로컬 메일박스 저장(`LocalMailboxManager`)
  - 스풀 큐잉(`MailSpooler`) + 재시도 + DSN(간단 텍스트 바운스)
  - 외부 릴레이(`MailRelay`)는 MX 조회(dnsjava) + Jakarta Mail(Angus)로 전달 시도
- 기본 방어:
  - 커맨드 라인 길이 제한, 메시지 크기 제한(SIZE/전역), idle timeout, IP 기반 rate-limit(연결 수/시간당 메시지 수)

### 목표(B: 인터넷 노출+릴레이) 기준 진척률(현실 평가)

- (작성 당시) **약 30~40%**
  - 코어 플로우는 있으나, STARTTLS/DATA/릴레이 보안 및 RFC/운영 안정화가 부족해 “공개 서비스”로는 아직 위험

> 업데이트(2026-01-02): 최근 기능 구현/안정화 반영 시 **약 65~75%**
>
> - Phase 1(STARTTLS/DATA/AUTH 보안) 완료
> - 릴레이 정책/아웃바운드 TLS 정책/스풀 재시도(수신자 단위) 등 핵심 기능이 실사용 수준으로 개선
> - 남은 큰 축은 “테스트/운영화(메트릭/장애 시나리오)”와 “SMTPUTF8 완성도(주소/헤더/릴레이 호환)” 쪽

---

## 치명 리스크(즉시 대응 필요) — Top Priority

### 1) STARTTLS 파이프라인 업그레이드 로직 불일치(중복 핸들러/프로토콜 파손 위험)

- 초기 파이프라인에 추가되는 디코더/인코더가 “이름 없이” 추가되는 반면,
- STARTTLS에서는 `"frameDecoder"`, `"stringDecoder"`, `"stringEncoder"` 같은 “이름 기반 제거”를 시도함
- 결과적으로 기존 핸들러 제거가 실패하고 **중복 디코더/인코더가 추가될 가능성**이 큼

**권장(최소 변경)**

- 초기 파이프라인에 핸들러 이름을 부여하고(`addLast("frameDecoder", ...)` 등), STARTTLS 로직이 그 이름을 기준으로 정확히 교체하도록 정리

**권장(더 안전한 구조)**

- STARTTLS 시 `SslHandler`만 addFirst로 삽입하고, 핸드셰이크 완료를 확인한 뒤 상태 플래그/세션 리셋 수행(핸드셰이크 실패 시 즉시 종료/정확한 응답)

> 참고(개발 메모): Netty의 SSL 파이프라인 구성은 `SslContextBuilder` + `SslHandler`를 통해 구성하며, 서버 파이프라인의 앞단에 `SslHandler`를 추가하는 패턴이 일반적입니다.

### 2) DATA 처리 실패/타임아웃에도 최종 `250 Ok`가 나갈 수 있음(프로토콜 의미 붕괴)

- DATA는 “메시지 수신/큐잉 성공”일 때만 250을 보내야 함
- 현재 구조는 핸들러 코루틴에서 실패 응답을 보낸 뒤에도, 커맨드 끝에서 다시 250을 보낼 가능성이 존재

**권장**

- DATA는 **단 한 번의 최종 응답**만 보내도록 구조를 변경
  - “핸들러 코루틴이 응답을 직접 보내지 않게” 하거나
  - 결과를 `Result`로 수집해서 `DataCommand`가 최종 응답을 단일로 책임지게 정리

### 3) AUTH 크리덴셜 로그 유출 가능성(보안 사고 위험)

- 세션 입력 라인을 통째로 로그(info)에 남김 → `AUTH PLAIN <base64>`가 그대로 남을 수 있음

**권장**

- `AUTH` 등 민감 커맨드는 **파라미터 마스킹 로깅**(예: `AUTH PLAIN ***`)
- 로그 레벨/샘플링/PII 정책 정리(운영 기본)

---

## 보안/운영 관점의 주요 갭(중요도 순)

### 릴레이 보안(오픈 릴레이 방지, TLS, 정책)

- **오픈 릴레이 방지 정책**을 더 명확히 해야 함
  - “외부 수신자”를 받는 경우(릴레이)에는 `requireAuthForRelay`/허용 도메인/인증 상태 조합을 명확히 문서화 및 테스트 필요
- 아웃바운드 릴레이에서 `mail.smtp.ssl.trust="*"`는 위험(실질적 검증 약화)
  - 최소: 운영 환경에서는 신뢰할 CA/도메인 검증 전략을 정리

### RFC/상태머신 정확도

- 응답 코드/확장 상태 코드(Enhanced Status Codes) 사용이 경로별로 섞여 있음
  - `sendResponse()`는 enhanced code를 포함하지만 `EHLO/HELO`는 직접 라인을 씀
- STARTTLS 이후 상태 리셋 규칙은 있으나 “핸드셰이크 실패/중간 종료” 케이스 보강 필요
- 확장 기능 광고와 실제 지원 범위가 반드시 일치해야 함(현재 일부는 보수적으로 광고 안 함 → 방향은 좋음)

### ESMTP 확장(실사용 기준) TODO

- (진행) **SMTPUTF8 최소 구현**
  - EHLO에 `SMTPUTF8` 광고
  - `MAIL FROM`의 `SMTPUTF8` 파라미터 수용 + 주소 검증 완화(UTF-8 local-part) + IDN 정규화
  - TODO: 완전 지원(주소/헤더/릴레이 경로 호환성, 표준 테스트)까지는 추가 작업 필요

### 리소스/내구성

- 스풀 락 파일(`.lock`)은 원자성/경합 안정성이 약할 수 있음(특히 향후 멀티 프로세스/클러스터링 고려 시)
- 대용량 메일/느린 클라이언트에서의 backpressure/timeout/메모리 경계가 명확해야 함

### 관측/운영(Observability)

- 현재는 actuator 의존성이 있으나, **SMTP 데몬(비웹)** 운영 형태에서 “어떤 포트/엔드포인트로 무엇을 노출할지” 재정의 필요
- 메트릭(연결 수/세션 수/전송 성공/실패/스풀 큐 길이/재시도 횟수) 정의가 필요

---

## 코드 품질/유지보수성 리팩터링 방향(To-Be)

### 1) 전역 레지스트리 제거(테스트/확장성)

- `AuthRegistry` 같은 전역 접근은 테스트 및 다중 인스턴스/다중 서버 구성에 불리
- 권장: `SmtpServer` 또는 `SmtpSession`에 `ServerServices`(auth/delivery/spool/policy)를 주입

### 2) “세션 상태” vs “메일 트랜잭션 상태” 분리

- `SessionData`에 greeting/TLS/AUTH/MAIL/RCPT가 함께 존재
- 권장: 트랜잭션용 상태(Envelope/Recipients/Declared SIZE 등)를 별도 객체로 분리하면 `RSET`, 에러, STARTTLS reset 규칙이 단순해짐

### 3) 응답 생성/로깅 정책의 단일화

- `respondLine` 직접 호출과 `sendResponse` 혼용을 줄이고, “항상 enhanced code 포함/미포함” 정책을 1개로 고정
- 민감정보 로깅 정책을 공통 유틸로 강제(실수 방지)

### 4) 불필요 의존성 다이어트(“다시 시작” 관점)

- Kafka 등 현재 목적(인터넷 노출 SMTP 릴레이)과 직접 관련이 약한 의존성은 1차 안정화 이후 필요 시 추가 권장

---

## 단계별 작업 로드맵(추천) — “인터넷 노출 가능한 릴레이 서버” 완성을 위한 플랜

> 원칙: **치명 리스크 제거 → 프로토콜 정확도 → 보안 강화 → 운영화 → 확장 기능** 순으로 진행합니다.

### Phase 0 — 기준선 확정(0.5~1일)

- **산출물**
  - 목표/비목표/운영 시나리오 문서(이 문서 기반으로 확정)
  - 설정 키 정리(`smtp.*`): 릴레이 정책, TLS 정책, 최대 크기/타임아웃, 로그 정책
- **완료 기준**
  - “인터넷 노출 시 필수 정책(STARTTLS/AUTH/릴레이 제어)”이 문서로 합의되어 있음

### Phase 1 — 치명 버그/보안 사고 방지(2~5일)

- **TODO**
  - STARTTLS 파이프라인 업그레이드 로직 정합성 확보(핸들러 이름 부여/교체)
  - TLS 핸드셰이크 실패 시 동작 정의(정확한 종료/응답)
  - DATA 최종 응답 단일화(실패 시 4xx/5xx, 성공 시 250)
  - `AUTH`(및 추후 민감 커맨드) 로그 마스킹
- **완료 기준**
  - STARTTLS를 여러 번 시도/실패/성공 케이스에서 세션이 깨지지 않음
  - DATA 실패 시 절대 250을 반환하지 않음
  - 운영 로그에 인증정보가 남지 않음

### Phase 2 — SMTP 상태머신/응답 일관성(3~7일)

- **TODO**
  - 응답 포맷 정책 통일(Enhanced Status Codes 포함 여부 일괄)
  - 명령 순서 규칙 강화(`HELO/EHLO` → `MAIL` → `RCPT` → `DATA`)
  - `RSET`, `QUIT`, STARTTLS 이후 state reset 규칙을 테스트로 고정
  - EHLO capability 광고 목록을 실제 지원 범위와 1:1로 맞춤
- **완료 기준**
  - “명령 시퀀스 테스트”가 통과하고, 회귀가 발생하면 테스트가 잡아냄

### Phase 3 — 릴레이 보안/정책 확정(3~7일)

- **TODO**
  - 릴레이 정책을 명확히 분리
    - 로컬 도메인 수신 OK
    - 외부 도메인 릴레이는 (인증 필수) 또는 (허용 도메인+인증) 등으로 명확히
  - 아웃바운드 TLS 검증 정책 정리(운영에서 trust-all 제거)
  - 오픈 릴레이 방지 회귀 테스트 추가
- **완료 기준**
  - 인증 없이 외부 릴레이가 절대 되지 않음(정책에 따라)
  - 아웃바운드 TLS 정책이 “운영 안전” 기준을 만족

### Phase 4 — 스풀/내구성/운영화(5~10일)

- **TODO**
  - 스풀 락/메타데이터 내구성 강화(원자적 락, 부분 실패 복구)
  - 메트릭 정의 및 노출(세션 수, 실패율, 스풀 큐 길이, 릴레이 성공/실패 등)
  - 장애 시나리오(디스크 full, DNS 실패, 외부 SMTP 다운)에서의 동작 정의
- **완료 기준**
  - 재시작/장애 후에도 스풀 메시지가 유실 없이 재처리됨(정의된 정책대로)
  - 운영자가 최소한의 지표로 상태를 판단 가능

### Phase 5 — 확장 기능/성능(선택, 이후)

- **후보**
  - PIPELINING(정확한 구현 필요), SMTPUTF8, 8BITMIME(지원 시 DATA 경로도 함께)
  - MX 캐싱(메모리/Redis) + TTL 만료
  - 다중 도메인/사용자 저장소(파일/DB) + 정책 엔진화

---

## 추천 테스트 계획(최소)

> 인터넷 노출 서버는 “테스트가 곧 방패”입니다. 아래 정도는 최소로 갖추는 것을 권장합니다.

### 프로토콜 시퀀스 테스트

- HELO/EHLO 이전 MAIL 거부(503)
- MAIL 후 RCPT 여러 번, DATA 전 최소 1 RCPT 필요
- RSET이 트랜잭션만 리셋하고 greeting 유지하는지
- STARTTLS 후 반드시 EHLO/HELO 강제되는지

### 보안 테스트

- AUTH 라인이 로그에 남지 않는지
- 인증 없이 외부 릴레이가 거부되는지(정책별)

### 내구성 테스트(스풀)

- 릴레이 실패 → 재시도 → max retry → DSN 생성 동작 확인

---

## 다음 액션(가장 추천)

- **Phase 1(치명 버그/보안)부터 바로 착수**하는 것이 가장 비용 대비 효과가 큼
  - STARTTLS 파이프라인/핸드셰이크
  - DATA 최종 응답 단일화
  - AUTH 로그 마스킹
