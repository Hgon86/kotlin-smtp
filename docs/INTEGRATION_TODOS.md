# 통합/아키텍처 미정 영역 TODO (MSA vs DB 직결 vs 파일/S3)

이 문서는 현재 SMTP 서버 코드를 “인터넷 노출 가능한 릴레이 서버”로 안정화하는 과정에서,
**아직 결정되지 않은 통합 방식(MSA / DB 직접 연결 / S3 업로드 등)**을 미리 TODO로 남기기 위한 문서입니다.

> 원칙: 지금 당장 결정을 강제하지 않고, **필요해지는 시점에 선택할 수 있도록 인터페이스/경계만 준비**합니다.

---

## 1) 메시지 저장소(EML) 전략

### 현재(As-Is)
- 스풀 디렉터리에 `.eml` + `.json` 메타 파일로 저장
- 로컬 수신(로컬 도메인)은 사용자별 mailbox 디렉터리에 `.eml`로 저장

### TODO 후보
- **TODO: EML을 S3(또는 호환 오브젝트 스토리지)에 업로드**
  - 업로드 실패 시 재시도/중복 업로드 방지(아이템포턴시 키) 필요
  - 스풀 메타에 `storageUri`(예: `s3://bucket/key`) 저장 필요
- **TODO: EML을 DB(BLOB)로 저장**
  - 용량/성능/백업 정책 고려 필요(대용량 메일은 DB에 부담)
- **TODO: EML을 로컬 파일로 유지 + 인덱스/검색만 DB**
  - 파일은 스토리지, 메타데이터만 DB

### TODO(로컬 수신 저장소)
- **TODO: 로컬 수신 메일박스 저장소를 DB/오브젝트 스토리지로 대체**
  - 예: DB(메일 메타) + S3(원문 eml) 조합
  - 다중 인스턴스/오토스케일링 환경에서 로컬 디스크는 한계가 큼
  - 조회(IMAP/웹메일 등)까지 고려하면 인덱스/검색 설계 필요

---

## 2) MSA(마이크로서비스) 기준으로 개발할지 vs DB 직결로 붙일지

### 선택지 A: MSA(권장 “장기” 방향)
- SMTP 서버는 “수신/릴레이/스풀”에 집중
- **이벤트/큐**로 다른 서비스(분석/스팸/규정/사용자 정책)와 통신

**TODO**
- TODO: `MessageAccepted`/`DeliveryFailed` 같은 이벤트 스키마 정의
- TODO: 이벤트 퍼블리시(예: Kafka/Redis Stream/SQS 등) 모듈 분리
- TODO: 정책(릴레이 허용/사용자 인증/도메인) 조회를 별도 Policy 서비스로 분리 가능하게 설계

### 선택지 B: DB 직접 연결(권장 “초기” 또는 단일 서비스)
- 단일 배포/단일 DB로 빠르게 구현 가능
- 다만 SMTP 처리는 I/O와 트래픽이 커서, DB에 과부하를 주기 쉬움

**TODO**
- TODO: DB 스키마(사용자/도메인/정책/메시지 메타) 설계
- TODO: 트랜잭션 경계/락/성능(메일 본문 저장 방식) 결정

---

## 3) “미정 영역을 안전하게 미루기 위한” 코드 레벨 TODO 방향

- TODO: `MessageStore`/`MessageSink` 같은 추상화 인터페이스 도입(지금은 파일 스풀 구현만)
- TODO: `SpoolMetadata`에 확장 필드 추가 가능하게 설계(예: `storageUri`, `traceId`, `policyId`)
- TODO: 운영/개발 환경별 설정 분리
  - 운영 기본값은 보안/검증 강화(릴레이 인증, TLS 검증)
  - 개발환경에서는 옵션으로 완화 가능(trustAll, 포트 확장 등)

