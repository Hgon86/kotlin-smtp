groups:
  - name: kotlin-smtp
    rules:
      - alert: SmtpSpoolPendingHigh
        expr: smtp_spool_pending > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "SMTP spool backlog is high"
          description: "Pending spool messages stayed above 1000 for 10 minutes."

      - alert: SmtpSpoolPendingCritical
        expr: smtp_spool_pending > 3000
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "SMTP spool backlog is critical"
          description: "Pending spool messages stayed above 3000 for 10 minutes."

      - alert: SmtpSpoolDroppedDetected
        expr: increase(smtp_spool_dropped_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "SMTP spool drops detected"
          description: "At least one message was dropped by spool retry policy in the last 5 minutes."

      - alert: SmtpSpoolPermanentFailureSpike
        expr: increase(smtp_spool_delivery_failure_total{kind="permanent"}[10m]) > 50
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Permanent recipient failures are spiking"
          description: "Permanent delivery failures exceeded 50 in 10 minutes. Check reason and policy tags."

      - alert: SmtpSpoolRetryDelayDrift
        expr: histogram_quantile(0.95, sum(rate(smtp_spool_retry_delay_seconds_bucket[10m])) by (le)) > 300
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Spool retry delay p95 is high"
          description: "Retry delay p95 exceeded 300 seconds in the last 10 minutes."

      - alert: SmtpSpoolQueueAgeDroppedHigh
        expr: histogram_quantile(0.95, sum(rate(smtp_spool_queue_age_seconds_bucket{outcome="dropped"}[10m])) by (le)) > 600
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Dropped-message queue age p95 is high"
          description: "Queue age p95 for dropped spool messages exceeded 600 seconds."
