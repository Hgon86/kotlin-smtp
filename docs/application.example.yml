spring:
  application:
    name: kotlin-smtp
  main:
    web-application-type: none

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true

smtp:
  # 단일 포트 모드: listeners가 비어있을 때 사용됩니다.
  # listeners를 설정하면 이 값은 무시됩니다.
  port: 2525
  hostname: localhost
  serviceName: ESMTP

  # 로컬 도메인 판정(로컬 전달 vs 외부 릴레이 분기)
  # - 필수 설정: 로컬 도메인 메일 수신/처리를 위해 필요합니다.
  routing:
    localDomain: mydomain.com

  # 리스너(포트)별 정책 분리(기능 구현 우선)
  # listeners를 지정하면 smtp.port 대신 이 목록을 사용합니다.
  # listeners:
  #   # MTA 수신(25/2525 등): opportunistic STARTTLS, AUTH 선택
  #   - port: 2525
  #     serviceName: ESMTP
  #     implicitTls: false
  #     proxyProtocol: false # LB/HAProxy 뒤라면 true + smtp.proxy.trustedCidrs 설정
  #     enableStartTls: true
  #     enableAuth: true
  #     requireAuthForMail: false
  #   # Submission(587): STARTTLS + AUTH 강제 권장
  #   - port: 587
  #     serviceName: SUBMISSION
  #     implicitTls: false
  #     proxyProtocol: false # LB/HAProxy 뒤라면 true + smtp.proxy.trustedCidrs 설정
  #     enableStartTls: true
  #     enableAuth: true
  #     requireAuthForMail: true
  #   # SMTPS(465): implicit TLS + AUTH 강제 권장
  #   - port: 465
  #     serviceName: SMTPS
  #     implicitTls: true
  #     proxyProtocol: false # SMTPS도 PROXY 헤더가 TLS보다 먼저 오므로 true 가능(단, 신뢰 프록시 필수)
  #     enableStartTls: false
  #     enableAuth: true
  #     requireAuthForMail: true

  # PROXY protocol(v1) 신뢰 프록시 CIDR 목록
  # - 보안상 필수: PROXY 헤더는 스푸핑이 가능하므로, LB/HAProxy 등 "신뢰 가능한 프록시"에서만 수용해야 합니다.
  proxy:
    trustedCidrs:
      - 127.0.0.1/32
      - ::1/128

  # 저장소 경로 설정 (필수)
  # - OS 중립적으로 상대경로를 기본 예시로 둡니다.
  # - 운영/배포 환경에서는 절대경로 또는 환경변수로 명시 권장.
  storage:
    mailboxDir: ${SMTP_MAILBOX_DIR:./data/mailboxes}
    tempDir: ${SMTP_TEMP_DIR:./data/temp}
    listsDir: ${SMTP_LISTS_DIR:./data/lists}

  ssl:
    # STARTTLS/SMTPS(implicit TLS)을 쓰려면 enabled=true + 인증서/키 파일이 필요합니다.
    # - 파일이 실제로 존재해야 TLS 컨텍스트가 활성화됩니다.
    enabled: false
    # certChainFile: /path/to/cert # 인증서 체인 파일 경로
    # privateKeyFile: /path/to/key # 개인 키 파일 경로

    # TLS 하드닝(선택)
    minTlsVersion: TLSv1.2 # TLSv1.2, TLSv1.3
    handshakeTimeoutMs: 30000
    cipherSuites: [] # 예: ["TLS_AES_128_GCM_SHA256"] (비우면 JVM 기본값)

  # 릴레이(외부 도메인 전달) 설정
  # - 활성화하려면 `kotlin-smtp-relay-spring-boot-starter` 의존성을 추가해야 합니다.
  # - 인터넷 노출 시에는 오픈 릴레이 방지를 위해 requireAuthForRelay=true 권장
  relay:
    enabled: false
    # legacy fallback (권장: smtp.routing.localDomain 사용)
    # localDomain: mydomain.com
    allowedSenderDomains: [] # 인증 없이 릴레이를 허용할 발신 도메인 allowlist(비우면 allowlist 예외 비활성)
    requireAuthForRelay: true
    outboundTls:
      ports: [25] # 운영 기본은 25. 개발환경에서만 [25, 587] 등으로 확장 권장
      startTlsEnabled: true # 기본: opportunistic STARTTLS
      startTlsRequired: false # true면 상대방이 STARTTLS 미지원 시 전달 실패 가능
      checkServerIdentity: true
      trustAll: false # 개발환경에서만 true 권장(운영에서는 false)
      trustHosts: [] # 예: ["mx.example.com"]
      connectTimeoutMs: 15000
      readTimeoutMs: 15000

  # 스풀러 기본 설정 (필수: dir)
  spool:
    dir: ${SMTP_SPOOL_DIR:./data/spool}
    maxRetries: 5
    retryDelaySeconds: 60

  auth:
    enabled: true
    required: false

    # AUTH 브루트포스 방지(기본 on)
    rateLimitEnabled: true
    rateLimitMaxFailures: 5
    rateLimitWindowSeconds: 300
    rateLimitLockoutSeconds: 600

    users:
      user: password
      secure: "$2a$10$CwTycUXWue0Thq9StjUM0uJ8ZrYcGQpFvWY9Y1KfK1aG1H0a4V/2m"

  # Rate Limiting 설정 (스팸 및 DoS 방지)
  rateLimit:
    maxConnectionsPerIp: 10 # IP당 최대 동시 연결 수
    maxMessagesPerIpPerHour: 100 # IP당 시간당 최대 메시지 수

  # 기능 플래그(인터넷 노출 기본값은 보수적으로 off)
  features:
    vrfyEnabled: false
    etrnEnabled: false
    expnEnabled: false

logging:
  level:
    root: info
    io.github.kotlinsmtp: info
