spring:
  application:
    name: kotlin-smtp
  main:
    web-application-type: none

management:
  # Use a dedicated management port to separate SMTP and observability traffic.
  # server:
  #   port: 8081
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true

smtp:
  # Single-port mode: used when listeners is empty.
  # If listeners is configured, this value is ignored.
  port: 2525
  hostname: localhost
  serviceName: ESMTP

  # Local domain routing decision (local delivery vs external relay).
  # Required for local domain mail acceptance and delivery.
  routing:
    localDomain: mydomain.com

  # Listener-level policy split by port.
  # If listeners is set, it overrides smtp.port.
  # listeners:
  #   # MTA inbound (25/2525): opportunistic STARTTLS, AUTH optional
  #   - port: 2525
  #     serviceName: ESMTP
  #     implicitTls: false
  #     proxyProtocol: false # Set true behind LB/HAProxy + configure smtp.proxy.trustedCidrs
  #     enableStartTls: true
  #     enableAuth: true
  #     requireAuthForMail: false
  #     idleTimeoutSeconds: 300 # 5 minutes (0 disables timeout)
  #   # Submission (587): STARTTLS + AUTH typically required
  #   - port: 587
  #     serviceName: SUBMISSION
  #     implicitTls: false
  #     proxyProtocol: false # Set true behind LB/HAProxy + configure smtp.proxy.trustedCidrs
  #     enableStartTls: true
  #     enableAuth: true
  #     requireAuthForMail: true
  #     idleTimeoutSeconds: 300
  #   # SMTPS (465): implicit TLS + AUTH typically required
  #   - port: 465
  #     serviceName: SMTPS
  #     implicitTls: true
  #     proxyProtocol: false # PROXY header comes before TLS; only enable with trusted proxies
  #     enableStartTls: false
  #     enableAuth: true
  #     requireAuthForMail: true
  #     idleTimeoutSeconds: 300

  # Trusted proxy CIDR list for PROXY protocol(v1).
  # Security note: PROXY headers are spoofable and must be accepted only from trusted proxies.
  proxy:
    trustedCidrs:
      - 127.0.0.1/32
      - ::1/128

  # Storage path settings (required).
  # Relative paths are shown for portability; use absolute paths or env vars in production.
  storage:
    mailboxDir: ${SMTP_MAILBOX_DIR:./data/mailboxes}
    tempDir: ${SMTP_TEMP_DIR:./data/temp}
    listsDir: ${SMTP_LISTS_DIR:./data/lists}

  ssl:
    # STARTTLS/SMTPS requires enabled=true and valid certificate/key files.
    enabled: false
    # certChainFile: /path/to/cert # Certificate chain file path
    # privateKeyFile: /path/to/key # Private key file path

    # Optional TLS hardening
    minTlsVersion: TLSv1.2 # TLSv1.2, TLSv1.3
    handshakeTimeoutMs: 30000
    cipherSuites: [] # Example: ["TLS_AES_128_GCM_SHA256"] (empty means JVM default)

  # Relay (external delivery) settings.
  # Add `kotlin-smtp-relay-spring-boot-starter` to enable relay features.
  relay:
    enabled: false
    # Legacy fallback (recommended: smtp.routing.localDomain)
    # localDomain: mydomain.com
    # Default Smart Host route (all external domains relay through this host)
    # defaultRoute:
    #   host: localhost
    #   port: 10025
    #   startTlsEnabled: false

    # Domain-based Smart Host routes
    # Priority: exact domain > '*' > defaultRoute > direct MX
    # routes:
    #   - domain: govkorea.kr
    #     host: localhost
    #     port: 10025
    #     startTlsEnabled: false
    #   - domain: "*"
    #     host: smtp.company.local
    #     port: 587
    #     username: relay-user
    #     password: ${RELAY_PASSWORD}

    allowedSenderDomains: [] # Unauthenticated relay sender-domain allowlist
    allowedClientCidrs: [] # Unauthenticated relay client CIDR allowlist (for example, 10.0.0.0/8)
    requireAuthForRelay: true
    outboundTls:
      ports: [25] # Production default is 25; expand in dev if needed
      startTlsEnabled: true # Opportunistic STARTTLS by default
      startTlsRequired: false # true may fail delivery to peers without STARTTLS
      checkServerIdentity: true
      trustAll: false # true is for local/dev testing only
      failOnTrustAll: false # set true in production to block insecure trustAll usage
      trustHosts: [] # Example: ["mx.example.com"]
      connectTimeoutMs: 15000
      readTimeoutMs: 15000

  # Spool settings (dir is required)
  spool:
    # Backend type: auto | file | redis
    # - auto: redis when StringRedisTemplate exists, otherwise file
    # - file: .eml/.json/.lock files
    # - redis: raw/queue/lock/metadata in Redis, temp file only at delivery time
    type: auto
    dir: ${SMTP_SPOOL_DIR:./data/spool}
    maxRetries: 5
    retryDelaySeconds: 60
    triggerCooldownMillis: 1000
    # Redis backend example
    # redis:
    #   keyPrefix: ${SMTP_SPOOL_REDIS_KEY_PREFIX:kotlin-smtp:spool}
    #   maxRawBytes: ${SMTP_SPOOL_REDIS_MAX_RAW_BYTES:26214400}
    #   lockTtlSeconds: ${SMTP_SPOOL_REDIS_LOCK_TTL_SECONDS:900}

  # Sent mailbox archiving policy
  sentArchive:
    # TRUSTED_SUBMISSION: store AUTH or external relay submissions (default)
    # AUTHENTICATED_ONLY: store only authenticated submissions
    # DISABLED: disable sent archiving
    mode: ${SMTP_SENT_ARCHIVE_MODE:TRUSTED_SUBMISSION}

  auth:
    enabled: true
    required: false
    allowPlaintextPasswords: true

    # AUTH brute-force protection (enabled by default)
    rateLimitEnabled: true
    rateLimitMaxFailures: 5
    rateLimitWindowSeconds: 300
    rateLimitLockoutSeconds: 600

    users:
      user: password
      secure: "$2a$10$CwTycUXWue0Thq9StjUM0uJ8ZrYcGQpFvWY9Y1KfK1aG1H0a4V/2m"

  # Rate limiting (spam/DoS protection)
  rateLimit:
    maxConnectionsPerIp: 10 # Max concurrent connections per IP
    maxMessagesPerIpPerHour: 100 # Max accepted messages per IP per hour

  # Feature flags (conservative defaults for internet-exposed deployments)
  features:
    vrfyEnabled: false
    etrnEnabled: false
    expnEnabled: false

  lifecycle:
    gracefulShutdownTimeoutMs: 30000

logging:
  level:
    root: info
    io.github.kotlinsmtp: info
